---
title: 事务处理
date: 2019-05-26
tags: [database]
weight: 7
---

* 事务：由某个用户执行的一个不能够被打断的对数据库的操作序列
* 影响因素
  * concurrency 并发控制
  * crash 故障恢复
* ACID
  * Atomicity：要么全部发生，要么都不发生
  * Consistency
  * Isolation：事务间不干扰
  * Durability
* 事务控制语句
  * begin transaction
    * 数据定义命令(DDL)
    * 自动提交方式: `set autocommit on|off`
    * 数据操纵命令(DML)
    * `set transaction readonly|readwrite isolation level readuncomitted|readcomitted|readrepeatable|serializable`
      * 脏读：一个事务读取到了另外一个事务没有提交的数据
      * 不可重复读：在一个事务内两次读到的数据是不一样的，因此称为是不可重复读
      * 幻象读：记录数不同
  * commit transaction
  * rollback transaction
    * savepoint
* 事务控制操纵
  * 事务开始：START T0
  * 提交事务：COMMIT T0
  * 回退事务：ABORT T0
* 数据访问操纵
  * INPUT(A)
  * OUTPUT(A)
  * READ(A,t)
  * WRITE(A,t)

## 并发控制

实现并发事务的可串行化调度

* 串行调度：每次是一个事务的所有操作
  * 串行调度不会破坏数据库状态的一致性
* 可串行化调度：对数据库状态的影响和某个串行调度相同
* 冲突：一对相邻操作，交换顺序改变结果
  * 同一事务相同操作是冲突
  * 不同事务对同一数据对象的读-写冲突
  * 不同事务对同一对象的写冲突
* 冲突可串行化调度：通过非冲突操作交换可变为串行调度
  * 充分条件
  * 冲突等价
  * 优先图无环
* 视图等价：对每个数据项
  * 一方能读到初始值，另一方也能读到初始值
  * 如果在调度S中事务Tk执行了rk(D)，并且读到的是由事务Tj写入的D的值，则在调度H中事务Tk的rk(D)读到的也必须是由事务Tj所写入的D的值
  * 如果在调度S中是由事务Tk来执行最后一条关于D的写操作wk(D)，则在调度H中也一定是事务Tk执行最后一条关于D的写操作wk(D)
  * 视图等价是冲突等价的必要非充分条件
* 锁
  * 排它锁(X-lock)
  * 共享锁(S-lock)
* 锁协议
  * 一级锁协议：写前必须申请X锁并维持到事务执行结束（脏读，不可重复读）
  * 二级锁协议：一级+读之前申请S锁并维持到读操作完成后（不可重复读）
  * 三级锁协议：一级+读之前申请S锁并维持到事务执行结束
  * 两阶段锁协议(2PL)
    * 申请并获得锁
    * 释放所有申请的锁
    * 两阶段锁事务：所有锁请求先于解锁请求
    * 由2PL事务所构成的任意合法调度S都是冲突可串行化的
* 锁粒度：一把锁可以封锁的数据对象大小
  * 锁粒度大，系统并发读低，并发控制开销小
  * 多粒度封锁
    * 多粒度树
* 意向锁
  * 如果对一个结点加‘意向锁’，则说明该结点的下层结点正在被加锁
  * 对任一结点加锁时，必须先对它的上层结点加‘意向锁’
  * 意向共享锁(IS锁)
  * 意向排它锁(IX锁)
  * 共享意向排它锁(SIX锁)
* 锁相容矩阵

![锁相容矩阵](/images/general/lock.png)

## 数据库恢复技术

* 数据转储(dump)：定期将数据库内容复制到其它储存设备
  * 结合数据库日志：转储的开始与结束点，事务更新操作
  * 数据库镜像
* 日志
  * undo日志：用于被放弃事务的撤销工作
    * 记录格式
      * 开始：Start T
      * 提交：Commit T
      * 放弃：Abort T
      * 更新：T,X,V (V是原来的值)
      * Flush Log: 内存中的日志记录写到磁盘
    * 修改操作结束后 Commit
    * 恢复过程：从尾部开始扫描整个日志，对未提交事务恢复数值，加入 Abort T
    * 检查点：系统停止接受 Start T，恢复，写入 CKPT
    * 非静止检查点
  * redo日志：用于已提交事务的重做工作
    * V是更新的值
    * Commit 写入后修改
  * undo/redo日志