---
title: Transport Layer
date: 2019-01-28
tags: [notes, network]
weight: 2
---

# 运输协议

## 可靠的按序网络服务

如：面向连接的LLC服务的局域网，面向连接的分组交换网络

* 寻址：套接字（端口和主机的结合）
* 复用
  * 上行复用：多个连接复用到单个底层连接
  * 下行复用：单个连接划分为多个底层连接
* 流量控制
  * 丢弃溢出报文（可靠网络下很不合适）
  * 反压机制
  * 滑动窗口协议
  * 信用量机制
    * 序号(SN)
    * 确认号(AN)
    * 窗口(W)
* 连接建立/终止
  * 建立：两次SYN
  * 终止：两次FIN

## 不可靠的网络服务

如：使用IP的网际互联，无确认LLC服务的局域网

* 按序交付
* 重传策略
  * 重传计时器
* 副本检测
  * 最大报文段生存时间
* 流量控制：信号量机制
  * 持续计时器
* 连接建立
  * 三次握手
    * SYN i
    * SYN j, AN=i+1
    * SN =i+1, AN=j+1
* 连接终止
* 崩溃恢复
  * 包活计时器

## TCP

### TCP 服务

* 服务原语：TS->TCP
* 相应原语: TCP->TS

### TCP 首部格式

| Source Port               | Destination Port | Seqence Number                          | Acknowledgement Number | Data Offset      | Reserved | Flags       | Window      | Checksum     | Urgent Pointer         | Options         |
| ------------------------- | ---------------- | --------------------------------------- | ---------------------- | ---------------- | -------- | ----------- | ----------- | ------------ | ---------------------- | --------------- |
| 16 bits                   | 16               | 32                                      | 32                     | 4                | 4        | 8           | 16          | 16           | 16                     | option,variable |
| Telnet=13,HTTP=80,TFTP=69 |                  | 第一个数据八位组的序号（SYN置位则加一） | 希望接受的序号         | 首部32位字的数量 |          | 置1含义见下 | 信用量分配W | 因特网检验和 | 紧急数据最后一个八位组 |                 |

| Flags | Function                 |
| ----- | ------------------------ |
| CWR   | 拥塞窗口减少             |
| ECE   | ECN-Echo                 |
| URG   | urgent point 字段有效    |
| ACK   | acknowledegment 字段有效 |
| PSH   | 推送功能                 |
| PST   | 连接复位                 |
| SYN   | 序号同步                 |
| FIN   | 发送者无其它数据         |

## UDP

| Source Port | Destination Port | Length | Checksum |
| ----------- | ---------------- | ------ | -------- |
| 16 bits     | 16               | 16     | 16       |

# 拥塞控制

* 理想情况（缓存无限）：正比，超过网络容量后为 1
* 实际情况：无拥塞正比，中等拥塞减缓，严重堵塞降低（丢弃，重传）

## 拥塞控制技术

* 反压
* 阻流分组
  * ICMP 源点抑制
* 隐式拥塞信令
  * 端系统通过检测传输时延增加和分组的丢弃完成
* 显示拥塞信令
  * 二进制：拥塞二进制指示
  * 基于信用值
  * 基于速率

## 通信量管理

* 丢弃的选择
  * 公平性
  * 服务质量
  * 预留
* 通信量整形(traffic shaping)
  * 通过减轻分组的堆集，使流量平滑
  * 关注离开交换机的通信量
* 通信量管制(traffic policing)
  * 判断传入分组是否符合服务质量规约
  * 关注进入交换机的通信量

### 权标桶

* 权标补充速率 $R$: 可连续支持的数据率
* 桶大小 $B$：短时间内允许数据率超过 $R$ 的量
* 任意时间段 $T$ 内，发送的数量不能超过 $RT+B$
* 权标生成器以 $R$ bps 向桶中补充权标，到达的分组消耗一定数量的权标进行传输

### 漏桶

* 计数器 $X$: 泄露速率为 1 的漏桶
* 每当有一个分组到达，计数器上升 $I$
* 使计数器超过最大值的分组违规

## TCP 拥塞控制

### 重传计时器管理

将重传计时器的值设置的比估计值大一点


#### 简单平均

* 实际往返时延  $\text{RTT}(i)$: 对第$i$个传输的报文段所观察到的往返时间
* $\text{ARTT}(K+1)=\frac{K}{K+1}\sum_{\text{RTT}(i)}$

#### 指数平均

* $\text{SRTT}(K+1)=\alpha\text{SRTT(K)}+(1-\alpha)\text{RTT}(K+1)$
* RFC 793: $\text{RTO}(K+1)=\min(\text{UPBOUND},\max(\text{LBOUND},\beta\text{SRTT}(K+1)))$

#### RTT 方差估计(Jacobson 算法)

* 指数平均不能很好处理方差较高的情况
* $\text{SRTT}(K+1)=(1-g)\text{SRTT}(K)+g\text{RTT}(K+1)$
* $\text{SERR}(K+1)=\text{RTT}(K+1)-\text{SRTT}(K)$
* $\text{SDEV}(K+1)=(1-h)\text{SDEV}(K)|\text{SERR}(K+1)|$
* 重传计时器 $\text{RTO}(K+1)=\text{SRTT}(K+1)+f\text{SDEV}(K+1)$

#### 指数RTO退避

* 重传时 $\text{RTO}=q\text{RTO}$

#### Karn 算法

* 报文超时重传后，收到确认既可能是第一次的 ACK，也可能是第二次的 ACK
* 不对重传报文测得的$\text{RTT}$更新
* 发送重传后用指数RTO退避
* 对后续报文使用 RTO 退避知道收到一个队未重传的报文段的确认为止

### 窗口管理

#### 慢启动

* 允许窗口 awnd = min(credit, cwnd)
* cwnd 拥塞窗口，连接建立时初始化为1，每收到一个确认+1（指数增长）
* credit 最近一次确认许可的未被使用的信用量

#### 拥塞时动态调整窗口

* 发生超时时（网络从饱和状态恢复困难）
  * 慢启动门限位目前拥塞窗口一半 ssthresh = cwnd/2
  * cwnd = 1，执行慢启动到 cwnd=ssthresh
  * 之后每过一个往返时延才将 cwnd 加一

#### 快重传

* 接收到失序的报文段时必须立即为已接收的最近一个按序到达的报文段发出 ACK，在空缺填补完成前需不断发送该 ACK，直到到达
* 当发送方收到 ACK 时应等待，若持续收到同一报文段的又3个 ACK 则重传

#### 快恢复

* 当需快重传时，避免慢恢复

### 显示拥塞通知

* ECN
  * 00:无能力
  * 01/10:有能力
  * 11:已遇到堵塞
* 发送方设置ECN=01/10
* 路由器检测到堵塞，准备丢弃的分组 ECN=01/10，则将该分组IP首部中 ECN 设为11并转发
* 接收方收到 11，则恢复时在 TCP ACK 中将 ECN-Echo 置位
* 发送方在下一个发送到接收方的分组中，将 CWR 置位

## 数据报拥塞控制协议 (DCCP)

* 拥塞崩溃：各行其道的流量过多且互不考虑
* TCP友好(TCP 兼容)：非TCP协议在遇到拥塞时可以产生与TCP类似行为
  * $T\leq\frac{1.22B}{R\sqrt{q}}$
  * 发送速率 $T$
  * 最大分组长度 $B$
  * 连接上的往返时延 $R$
  * 分组丢弃率 $p$
* DCCP 运行在 IP 上，原本使用 UDP 的应用程序作为可替代的运输协议
  * 不存在重传，确认字号为收到的最大序列号
  * 三次握手

| 分组类型      |             |
| ------------- | ----------- |
| DCCP-Request  | 握手第一次  |
| DCCP-Response | 握手第二次  |
| DCCP-Data     |             |
| DCCP-ACK      | 无Data时ACK |
| DCCP-DataAck  |             |
| DCCP-CloseReq | 关闭请求    |
| DCCP-Close    | 关闭连接    |
| DCCP-Reset    | 终止连接    |
| DCCP-Sync     |             |
| DCCP-SyncAck  |             |

| 源端口 | 目标端口 | 数据偏移           | CCVal                  | CsCov(检验范围) | 检验和       | RES | 类型     | 扩展序列号 | RES | 序列号 | 可选 |
| ------ | -------- | ------------------ | ---------------------- | --------------- | ------------ | --- | -------- | ---------- | --- | ------ | ---- |
| 16bits | 16       | 8                  | 4                      | 4               | 16           | 3   | 4        | 1          | 8   | 48/28  |      |
|        |          | 应用数据开始偏移量 | 发送方拥塞控制机制使用 | 检验和检验范围  | 因特网检验和 |     | 分组类型 | 1则48bits  |     |        |      |

* DCCP 拥塞控制
  * 类TCP拥塞控制 CCID 2：宽带利用率最大化
  * TCP 友好性速率控制 TFRC/CCID 3: 平滑性