---
title: Network Layer
date: 2019-01-28
tags: [notes, network]
weight: 3
---

# 网际协议

| 术语         |                                          |
| ------------ | ---------------------------------------- |
| 互联网       | 通过网桥和路由器相互连接的通信网络的集合 |
| 端系统(ES)   |                                          |
| 中间系统(IS) |                                          |
| 路由器       |                                          |

* 要求：
  * 提供网络与网络间的链路：至少需要一条物理连接和一条链路控制连接
  * 为位于不同网络上的进程间提供数据的路由选择和交付功能
  * 审计服务
  * 容纳网络间的不同
    * 路由选择
      * 路由表 netstat -nr
    * 数据报生存时间
    * 分片和重装
    * 差错恢复
    * 流量控制
* 提供无连接操作/数据报服务
  * 不保证交付数据以正确顺序到达
  * 不保证数据全部交付

## IPv4

### 服务

* 原语：执行的功能
  * 发送原语：请求数据单元的传输
  * 交付原语：通知有数据到达
* 参数：传递数据和控制信息
  * 源地址，目的地址
  * 协议
  * 服务类型指示，标识，不分片标识符，生存时间，数据长度，数据

### IP数据报格式

| 版本   | 互联网首部长度 IHL                | DS           | ECN          | 总长度 | 标识 | 标志 | Fragment Offset            | Time to Live | 协议         | 首部检验和   | 源地址 | 目的地址 | 选择+填充 | 数据       |
| ------ | --------------------------------- | ------------ | ------------ | ------ | ---- | ---- | -------------------------- | ------------ | ------------ | ------------ | ------ | -------- | --------- | ---------- |
| 4 bits | 4 bits                            | 6            | 2            | 16     | 16   | 3    | 13                         | 8            | 8            | 16           | 32     | 32       |           | $<65535*8$ |
| 4      | 以32比特为单位首部长度，最小值为5 | 区分服务功能 | 阻塞通知字段 |        |      |      | 数据报片在源数据报中的位置 | TTL          | TCP=6,UDP=17 | 因特网检验和 |        |          |           |            |


### IP地址

| 分类            | 格式                                    |                                       | 默认子网掩码  | 子网掩码举例    |
| --------------- | --------------------------------------- | ------------------------------------- | ------------- | --------------- |
| 保留            | 主机部分全零或全一                      | 前缀(网络)(主机)                      | 255.0.0.0     | 255.192.0.0     |
| A类             | 0(7)(24)                                | $126$ 网络地址                        | 255.255.0.0   | 255.255.248.0   |
| B类             | 10(14)(16)                              | $2^{14}=16384$ 网络地址               | 255.255.255.0 | 255.255.255.252 |
| C类             | 110(21)(8)                              | $2^{21}=2097152$ 网络地址             |               |                 |
| D类             | 1110(28)                                | 多播                                  |               |                 |
| E类             | 1111(28)                                | 留用                                  |               |                 |
| Private Address | 10./172.16~172.31/192.168.0~192.168.255 | 1个A类地址，16个B类地址，256个C类地址 |               |

### ICMP 网际控制报文协议

| 类型   | 编码 | 检验和 | 参数 | 数据 |
| ------ | ---- | ------ | ---- | ---- |
| 8 bits | 8    | 16     | 32   |      |

| 类型                       | 功能                                                   |
| -------------------------- | ------------------------------------------------------ |
| 终点不可达;超时;源站抑制   | 路由器不知道如何到达；生存时间超时或重装超时；流量控制 |
| 参数问题,Echo              | 语法或语义错误                                         |
| 重定向                     | 建议一条更好的路由                                     |
| 回送和回送回答             | 测试两个实体能否通信                                   |
| 时间戳和时间戳回答         | 对互联网时延特性采样                                   |
| 地址掩码请求和地址掩码回答 | 使主机知道所连接的局域网地址掩码                       |

### ARP 地址解析协议

将 IP地址映射为子网地址

* 局域网中每个系统维护一张已知IP与子网地址映射的表 arp -a
* 找不到时发起 ARP 广播
* 其它主机监听 ARP，匹配时回复
* 原始请求中包括发出请求的主机IP和子网地址，其它主机可将次信息复制到本地表

## IPv6

| IPv6 首部 | 逐帧选项首部(可选) | 路由选择首部(可选) | 分片首部(可选) | 目的地选择首部(可选) | TCP首部(可选) | 应用数据 |
| --------- | ------------------ | ------------------ | -------------- | -------------------- | ------------- | -------- |
| 40 bytes  | variable           | variable           | 8              | variable             | 20            |          |
|           | 逐跳处理           | 路由选择           | 分片和重装信息 |                      |               |          |

### IPv6 首部

| 版本   | DS/ECN | 流标号       | 有效载荷长度          | 下一首部       | 跳数限制 | 源地址 | 目的地址 |
| ------ | ------ | ------------ | --------------------- | -------------- | -------- | ------ | -------- |
| 4 bits | 6+2    | 20           | 16                    | 8              | 8        | 128    | 128      |
| 6      |        | 为分组做标记 | 扩展首部+数据单元长度 | IPv6首部后类型 |          |        |          |

* 流
  * 源点角度：某一应用实例生成并具有相同传送服务需求的分组序列
  * 路由器角度：相同属性分组序列
* 任播：一组接口的标识符，交付到最近的一个接口上

### IPv6 地址

地址为结点上的接口设置；地址格式 ipv6地址/前缀长度

| 类型         | IPv6表示法        |
| ------------ | ----------------- |
| 嵌入式IPv4   | ::FFFF:x.x.x.x/96 |
| 回路         | ::1/128           |
| 链路本地单播 | FE80::/10         |
| 多播:        | FF00::/8          |
| 全局单播     | 其它所有          |

## IPSec

* VPN(虚拟专用网络)：通过相对而言不太安全的网络互相连接在一起
* 鉴别首部(AH)
* 封装安全有效载荷(ESP)
  * transport
  * tunnel mode
* 秘钥交换功能

## 多播

* 应用：多媒体，电话会议，数据库，分布式计算，实时工作组
* 多播产生的通信量小于广播和多次单播：构建生成树

### IGMP 网际组管理协议

IGMPv3  
IPv6 中整合进 ICMPv6

#### 成员关系查询

| 类型                               | 最长响应时间 | 检验和 | 组地址         | Res | S                                     | QRV                                | QQIC               | 源数量 | 源地址 |
| ---------------------------------- | ------------ | ------ | -------------- | --- | ------------------------------------- | ---------------------------------- | ------------------ | ------ | ------ |
| 8bits                              | 8            | 16     | 32             | 4   | 1                                     | 3                                  | 8                  | 16     |        |
| 一般查询/指明组查询/指明组合源查询 | 单位：0.1s   |        | 0/有效多播地址 |     | 1：抑制因收到查询而执行正常计时器更新 | 非零则包含查询者所用的健壮性变量值 | 查询者的查询者间隙 |        |        |

#### 成员关系报告

| 类型  | Res | 检验和 | Res | 组记录数量 | 组记录                                                         |
| ----- | --- | ------ | --- | ---------- | -------------------------------------------------------------- |
| 8bits | 8   | 16     | 16  | 16         | 包含记录类型，辅助数据长度，源数量，多播地址，源地址和辅助数据 |

### 协议独立多播 (PIM)

路由选择协议

#### 稀疏模式 PIM (RFC 2362)

* 多播组其中一台路哟欧气为集合点 RP
* 组目的路由器向集合点发送 Join 报文。路由器用单播向该集合点发送，逆路径成为分布树一部分
* 允许目的路由器用通往源路由器的最短路径树替换共享树（发送Prune）

#### 密集模式 PIM

适用于自治系统内部的多播路由选择，对 MOSPF 的备用协议

* 归属网络：一个移动结点被分配给的特定的网络
  * 归属代理
  * 归属地址
* 外地网络
  * 外地代理
  * 转交地址

## 移动IP(RFC 3344)

让移动设备用户，能够从一个网上系统中，移动到另一个网上系统，但是设备的IP地址保持不变

### 发现

移动结点使用一种发现过程来识别预期的归属代理和外地代理

* 利用 ICMP 路由器通告报文
* 移动结点判断自己是在归属网络还是外地网络
* 代理通告报文：充当代理的路由器或其他网络设备定期发布带有通告扩展的路由器通告 ICMP 报文

### 登记

* 移动结点通过向它希望使用的外地代理发送一个等级请求报文来请求转发服务
* 外地代理将这个请求转交给移动结点的归属代理
* 归属代理接受或者拒绝这个请求，向外地代理发送一个登记回答
* 外地代理将这个回答转交给移动结点

### 隧道

* 为了捕获正在归属网络中传播目的为该结点的分组，归属代理需要盗用移动结点身份
* 封装：归属代理将整个IP数据报放入一个外部IP数据报中
  * IP在IP中的封装(RFC 2003)：增加一个完整的新IP首部
  * 最小封装 (RFC 2004)：生成新的外部IP首部时，原始IP首部进行修改
  * 普通选路封装 (RFC 1701)

## DHCP 动态主机配置协议

* 动态为主机分配IP地址
* 客户机/服务器模式，客户机为开机时需要一个地址的任何主机

| DHCP 报文    |                                              |
| ------------ | -------------------------------------------- |
| DHCPDISCOVER | 客户机用广播找出有效服务器                   |
| DHCPOFFER    | 服务器响应 DHCPDISCOVER，提供配置参数        |
| DHCPREQUEST  | 广播客户机选择的服务器                       |
| DHCPACK      | 服务器到客户机的报文，携带配置参数和网络地址 |
| DHCPRELEASE  | 客户机表示放弃对网络地址的租用               |

# 路由选择

* 性能评估标准：代价（时延，吞吐量，跳数），公平性

## 分组交换网络路由选择

### 固定式路由选择

为每一对源节点何目的结点选择永久路由；每个结点只需知道路由上第一个结点标识

### 洪泛

每个结点收到分组后传到除分组到达所经过的链路外其它链路；设置跳数计数器或重复则抛弃

* 优点：高度稳健
* 缺点：通信负荷高，安全风险

### 随机路由选择

为每个输出链路分配一个概率，例如基于数据率 $P_i=\frac{R_i}{\sum_jR_j}$

### 自适应路由选择

* 判决条件：故障或拥塞

### APPANET 第一代(距离向量,Bellman-Ford)

* 每个结点维护两个向量：$D_i,S_i$
  * $D_i$: 结点$i$的时延向量，$D_{ij}$ 为从$i$到$j$的最小时延的当前估算值
  * $S_i$: 结点$i$的后继结点向量，$S_{ij}$ 为$i$到$j$最小时延路由的下一个结点
* 周期性与相邻结点交换时延向量
  * $A$: 相邻结点集合
  * $l_{ki}$: 从$k$到$i$的当前估计时延
  * $D_{kj}=\min_{i\in A}(D_{ij}+l_{ki})$
  * $S_{kj}=\arg\min_{i\in A}(D_{ij}+l_{ki})$
* 缺点
  * 没有考虑容量
  * 导致振荡状态

### APPANET 第二代(链路状态,Dijkstra)

* 分组中包含时延信息，所有结点维护了网络中各条网络中各链路上的估算时延
* 每10s交换一次，新信息到达则用 Dijstra 计算路由选择表
* 缺点：链路上测量的分组时延与链路实际遇到的时延不符

### APPANET 第三代

* 改变代价函数
  * 单排队服务模式：利用率 $\rho=\frac{2(T_s-T)}{T_s-2T}$
  * 服务时间 $T_x$ 为平均分组长度处理链路比特率
  * 平均利用率 $U(n+1)=0.5*\rho(n+1)+0.5*U(n)$
  * 链路代价为平均利用率的函数

## 互联网路由选择

* 自治系统(AS):由一个机构进行管理的一组路由器和网络集合，包含一组使用相同路由选择协议交换信息的路由器
* 距离向量路由选择
* 链路状态路由选择
* 路径向量路由选择

### 开放最短路径优先协议(OSPF,RFC 2328)

属于内部路由器协议，自治系统内部传递路由选择信息

* 每个路由器维护一个数据库，反映该路由器掌握的所属自治系统的拓扑结构
  * 顶点：路由器或网络
  * 边：路由器与路由器点对点连或路由器与网络顶点连

### 边界网关协议(BGP)

属于外部路由协议，不同自治系统

| 报文类型     |                                  |
| ------------ | -------------------------------- |
| Open         | 实现邻站获取                     |
| Update       | 传输路由信息                     |
| Keepalive    | 确认 Open 及周期性保持邻站可达性 |
| Notification | 检测到错误时发送                 |

| 标记    | Length   | Type     | 参数         |
| ------- | -------- | -------- | ------------ |
| 16bytes | 2        | 1        |              |
| 鉴别    | 报文长度 | 报文类型 | 四种类型不同 |

* Update
  * AS_PATH: 路由经过的自治系统
  * Next_Hop: 下一跳
  * NLRI: 某自治系统中所有网络列表（由OSPF得到）
